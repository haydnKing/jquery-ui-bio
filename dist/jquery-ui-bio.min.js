/*! jQuery Ui Bio - v0.1.0 - 2013-01-06
* https://github.com/Gibthon/jquery-ui-bio
* Copyright (c) 2013 Haydn King; Licensed MIT, GPL */
this.bio=this.bio||{},function(){var e=function(e,t,n){this.init(e,t,n)},t=e.prototype;t.init=function(e,t,n){this.start=e||0,this.end=t||0,this.strand=(n||1)>0?1:-1;if(this.end<this.start){var r=this.end;this.end=this.start,this.start=r}},t.overlaps=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)if(this.contains(e[t].start)||this.contains(e[t].end)||e[t].contains(this.start))return!0;return!1},t.contains=function(e){return this.start<=e&&this.end>e},t.length=function(){return this.end-this.start},bio.FeatureLocation=e;var n=function(e,t,n,r){this.init(e,t,n,r)},r=n.prototype;r.location=null,r.type="NoneType",r.id=-1,r.qualifiers={},r.strand=function(){return this.location.strand},r.length=function(){return this.location.length()},r.overlaps=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)if(this.location.overlaps(e[t].location))return!0;return!1},r.toString=function(){return"[seqFeature (id="+this.id+", type="+this.type+"]"},r.init=function(e,t,n,r){n==null&&(n=-1),this.location=e,this.type=t||"NoneType",this.id=n,this.qualifiers=r||{}},bio.SeqFeature=n,bio.loadFeatureLocation=function(t){Array.isArray(t)||(t=[t]);var n=[];for(var r=0;r<t.length;r++)n.push(new e(t[r].start,t[r].end,t[r].strand));return n},bio.loadSeqFeature=function(e){Array.isArray(e)||(e=[e]);var t=[];for(var r=0;r<e.length;r++)t.push(new n(bio.loadFeatureLocation(e[r].location)[0],e[r].type,e[r].id,e[r].qualifiers));return t};var i=function(e,t,n){this.init(e,t,n)},s=i.prototype;s.features=[],s.tile_size=1024,s.length=0,s.types=[],s.by_type={},s.stacks={},s.tiles=[],s.getTypes=function(){return this.types},s.getFeatures=function(){return this.features},s.getFeaturesByType=function(e){return this.by_type[e.toLowerCase()]},s.getFeaturesByTile=function(e){return this.tiles[e]},s.pos2tile=function(e){return Math.floor(e/this.tile_size)},s.tile2pos=function(e){return[this.tile_size*e,this.tile_size*(e+1)]},s.init=function(e,t,n){this.features=e||[],n!=null&&(this.tile_size=parseInt(n,10)),this.length=t,this._calc_types(),this._calc_tracks(),this._calc_tiles()},s._calc_types=function(){var e,t,n;this.by_type={},this.types=[];for(e=0;e<this.features.length;e++)t=this.features[e],n=t.type.toLowerCase(),this.by_type.hasOwnProperty(n)||(this.by_type[n]=[],this.types.push(n)),this.by_type[n].push(t)},s._calc_tracks=function(){var e,t,n,r;this.stacks={fwd:{},rev:{}};for(e=0;e<this.types.length;e++){t=this.getFeaturesByType(this.types[e]),n=[],r=[];for(var i=0;i<t.length;i++)t[i].strand()>=0?n.push(t[i]):r.push(t[i]);this.stacks.fwd[this.types[e]]=this._set_tracks(n),this.stacks.rev[this.types[e]]=this._set_tracks(r)}},s._set_tracks=function(e){if(e.length===0)return 0;var t=0,n,r,i=[[]],s;e.sort(function(e,t){return t.length()-e.length()});for(n=0;n<e.length;n++){r=e[n],s=!1;for(t=0;t<i.length;t++)if(!r.overlaps(i[t])){s=!0;break}s?(i[t].push(r),r.track=t):(r.track=i.length,i.push([r]))}return i.length},s._calc_tiles=function(){var e,t,n,r,i,s;this.tiles=[];for(t=0;t<this.length/this.tile_size;t++){r={};for(n=0;n<this.types.length;n++)r[this.types[n]]=[];this.tiles.push(r)}for(t=0;t<this.features.length;t++){e=this.features[t],i=this.pos2tile(e.location.start),s=this.pos2tile(e.location.end-1);for(r=i;r<=s;r++)this.tiles[r][e.type].push(e)}},bio.FeatureStore=i}(),function(e,t){var n="tooltip ui-widget ui-widget-content ui-corner-all",r="tooltip-left",i="tooltip-right",s="tooltip-top",o="tooltip-bottom",u="ui-widget-content",a="stringContent",f="tip",l=150,c="black";e.widget("bio.tooltip",{options:{hover:250,click:!1,holdOpen:!0,autoClose:!0,content:null,extraClasses:null,width:100,color:"default",location:"center",direction:"auto",fadeIn:0,fadeOut:100},_create:function(){var t=this.el=e(this.element[0]),n=this.options,r=this;this._tooltip=null,this._evt=null,this._visible=!1,this._enabled=!0,this._timeout=null},_init:function(){this._bind_events()},show:function(){if(!this._enabled)return;this._visible&&this.hide(),this._create_tip(),this._set_content(),this._set_size(),this._set_location(),this._set_color(),this._tooltip.fadeTo(this.options.fadeIn,1),this._visible=!0},hide:function(){if(!this._visible)return;var e=this,t=e._tooltip;this._tooltip.fadeOut(this.options.fadeOut,function(){t.remove()}),this._visible=!1,e._tooltip=null},enable:function(){this._enabled=!0},disable:function(){this._enabled=!1,this.hide()},_bind_events:function(){var e=this;this.el.mousemove(function(t){e._mousemove(t)}).mouseleave(function(t){e._mouseleave(t)}).mouseenter(function(t){e._mouseenter(t)}).click(function(t){e._mouseclick(t)})},_mousemove:function(e){if(!this._enabled)return;this._evt=e;var t=this;!this._visible&&this.options.hover>0&&(this._clear_timeout(),this._set_timeout(this.options.hover,function(){t.show()}))},_mouseleave:function(e){if(!this._enabled)return;this._evt=e;var t=this;this.options.autoClose&&this._set_timeout(l,function(){t.hide()})},_mouseenter:function(e){if(!this._enabled)return;this._evt=e,this._clear_timeout()},_mouseclick:function(e){if(!this._enabled)return;this._evt=e,this.options.click&&this.open()},_clear_timeout:function(){typeof this._timeout=="number"&&(clearTimeout(this._timeout),this._timeout=null)},_set_timeout:function(e,t){this._clear_timeout(),this._timeout=setTimeout(function(){this._timout=null,t()},e)},_create_tip:function(){var t=this;this._tooltip=e("<div>").addClass(n+" "+(this.options.extraClasses||"")).fadeTo(0,0).mouseenter(function(e){t._mouseenter(e)}).mouseleave(function(e){t._mouseleave(e)}).append(e("<div>").addClass(u)).appendTo(e("body"))},_set_content:function(){var t=this.options.content;e.isFunction(t)&&(t=t(this._evt));if(this.el.attr(f)!=null)t=e("<p>").text(this.el.attr(f)).addClass(a);else if(typeof t=="string")t=e("<p>").text(t).addClass(a);else if(Array.isArray(t)){var n=t;t=e();for(var r=0;r<n.length;r++)t=t.add(this._make_item(n[r]))}else if(!(t instanceof e))throw"No content specified";this._tooltip.children("div").empty().append(t)},_set_size:function(){var e=this.options.width,t;if(typeof e=="string"&&/%$/.test(e)){var n=parseFloat(e.match("([0-9.]+)%")[1]);e=this.el.width()*n/100}this._tooltip.width(e)},_set_location:function(){var t=this.options.location,n=this.options.direction,u,a,f,l,c;if(t==="center")u=this.el.offset(),u.left+=this.el.width()/2,u.top+=this.el.height()/2;else{if(t!=="mouse")throw"Invalid location '"+t+"'";u={top:this._evt.pageY,left:this._evt.pageX}}n==="auto"&&(a={width:e(window).width(),height:e(window).height()},f={top:e(document).scrollTop(),left:e(document).scrollLeft()},l={width:this._tooltip.outerWidth(!0),height:this._tooltip.outerHeight(!0)},c={top:u.top-f.top,left:u.left-f.left,bottom:f.top+a.height-u.top,right:f.left+a.width-u.left},c.bottom>=l.height&&c.left>=l.width/2&&c.right>=l.width/2?n="s":c.top>=l.height&&c.left>=l.width/2&&c.right>=l.width/2?n="n":c.right>=l.width&&c.top>=l.height/2&&c.bottom>=l.height/2?n="e":c.left>=l.width&&c.top>=l.height/2&&c.bottom>=l.height/2?n="w":c.right>=c.left?n="e":n="w"),e.isFunction(n)&&(n=n(this._evt));var h=this._tooltip;if(n==="n")h.addClass(s),u.left-=l.width/2,u.top-=l.height;else if(n==="s")h.addClass(o),u.left-=l.width/2;else if(n==="e")h.addClass(i),u.top-=l.height/2;else{if(n!=="w")throw"Unknown direction '"+n+"'";h.addClass(r),u.left-=l.width,u.top-=l.height/2}h.css(u)},_set_color:function(){var e=this.options.color;if(e==="default"){if(this.el.css("border-color").length>0)return;console.log("Applying a default border as none set"),e=c}else e==="parent"&&(e=this.el.css("border-color"));this._tooltip.css("border-color",e)},_make_item:function(t){var n=this,r=e("<span>");t.icon!=null&&t.icon!==""?r.addClass("ui-icon "+t.iconClass||""):r.css(t.iconCSS||{}).addClass("ui-corner-all");var i=e("<div>").addClass("tooltip-item ui-widget-content ui-state-default").append(e("<div>").addClass("tooltip-icon").append(r)).append(e("<div>").addClass("tooltip-desc").append(e("<span>").text(t.title)).append(e("<p>").text(t.sub||""))).mouseenter(function(e){i.addClass("ui-state-hover")}).mouseleave(function(e){i.removeClass("ui-state-hover")}).mousedown(function(e){i.addClass("ui-state-active")}).mouseup(function(e){i.removeClass("ui-state-active")}).click(function(r){e.isFunction(t.click)&&t.click(r,n)});return i}})}(jQuery),function(e,t){var n="bio-help ui-widget",r="bio-help-tip",i="ui-corner-all";e.widget("bio.help",{options:{helphtml:"Some Help",open:t,close:t,width:null},_init:function(){var t=this,i=this.options,s=this.el=e(this.element[0]).addClass(n),o=e("<div>").addClass(r);s.hasClass("ui-corner-all")&&o.addClass("ui-corner-all"),this.help=e("<p>").html(i.helphtml).appendTo(o),this.el.tooltip({content:o,width:this.options.width||250})},_create:function(){},setHelp:function(e){this.options.helphtml(e),this.help.html(e)}})}(jQuery),function(e,t){var n="ui-widget bio-panel",r="ui-widget-header ui-state-default",i="bio-panel-content ui-state-default",s="ui-widget-content ui-state-default",o="ui-state-default ui-widget-content statusbar",u="bio-footer ui-widget-header ui-state-default",a="ui-icon-circle-triangle-e";e.widget("bio.panel",{options:{title:t,help:t,text:{defaultTitle:"Bio Panel",defaultHelp:"",defaultStatus:"Ready"},height:400,showStatus:!0},_create:function(){var t=this,s=this.options,a=this.el=e(this.element[0]).addClass(n);s.title=s.title||s.text.defaultTitle,s.help=s.help||s.text.defaultHelp,s.color=s.color||next_color();var f=this.head=e("<div>").addClass(r).appendTo(a),l=this.panel=e("<div>").addClass(i).appendTo(a),c=this.status_bar=e("<div>").addClass(o).appendTo(a),h=this.foot=e("<div>").addClass(u).appendTo(a);this.stretch_factors={panel:1},this.title=e("<span>").addClass("title").text(s.title).appendTo(f);var p=this.help=e("<span>").appendTo(f).help({helphtml:s.help});this.status_icon=e("<span>").addClass("ui-icon").appendTo(c),this.status_text=e("<p>").appendTo(c),s.showStatus||c.hide(),a.hasClass("ui-corner-all")&&(f.addClass("ui-corner-top"),h.addClass("ui-corner-bottom"),p.addClass("ui-corner-all"))},_init:function(){this._set_height()},option:function(e,t){if(t==null)return this.options[e];switch(e){case"title":this.head.find("span").text(t);break;case"help":this.help("setHelp",t);break;case"height":this._set_height(t)}this.options[e]=t},setStatus:function(e,t){this.status_icon.attr("class","ui-icon "+(t||a)),this.status_text.text(e||this.options.text.defaultStatus)},_set_height:function(){var e=0,t=0;for(var n in this.stretch_factors)t+=this.stretch_factors[n],e+=this[n].outerHeight();var r=this.el.outerHeight()-e;e=Math.max(0,this.options.height-r),console.log("Stretch = "+e);for(n in this.stretch_factors)console.log("this["+n+"].outerHeight("+e*this.stretch_factors[n]/t+");"),this[n].outerHeight(e*this.stretch_factors[n]/t)},_add_to_panel:function(e){return e.addClass(s),this.panel.append(e),e}})}(jQuery);var next_color=function(){var e=Math.random()*360,t=360/1.61803;return function(){return e=Math.floor(e+t)%360,"hsl("+e+",40%,50%)"}}();(function(e,t){var n="bio-search ui-widget",r="ui-state-default",i="ui-state-hover",s="ui-state-focus";e.widget("bio.search",{options:{text:{search:"search"},change:t},_create:function(){var t=this,i=this.options,s=this.el=e(this.element[0]).addClass(n);this.timeout=null,s.addClass(n).addClass(r),this.input=e('<input type="text">').appendTo(e("<div>").appendTo(s)),this.search_hint=e("<div>").addClass("hint").text(i.text.search).appendTo(s),e("<span>").addClass("ui-icon ui-icon-search").appendTo(s),this.search_clear=e("<span>").addClass("ui-icon ui-icon-close").hide().appendTo(s)},_init:function(){var t=this,n=this.options;this.input.on({focus:function(){t.search_hint.hide(),t.el.removeClass(i).addClass(s)},blur:function(){e(this).val()||(t.search_hint.show(),t.search_clear.hide()),t.el.removeClass(s)},keyup:function(){var e=t.input.val();e?t.search_clear.show():t.search_clear.hide(),t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout(function(){t.timeout=null,t._trigger("change",e)},500)}}),this.el.on({click:function(){t.input.focus()},mouseenter:function(){t.el.hasClass(r)&&t.el.addClass(i)},mouseleave:function(){t.el.hasClass(i)&&t.el.removeClass(i)}}),this.search_clear.on("click",function(){t.input.val(""),t.search_clear.hide(),t._trigger("change")})},value:function(e){if(e!=null){this.input.val(e),this._trigger("change");return}return this.input.val()}})})(jQuery),function(e,t){var n="bio-fragment ui-widget",r="ui-state-hover ui-state-active",i="ui-state-disabled",s="bio-fragment-info",o=10,u=function(e,t,n){n==null&&(n=!0);var r=t/2,i=e-r,s=n?r:-r,o=n?0:r,u="M"+o+",0 h"+i+" l"+r+","+r+" l"+ -r+","+r+" h"+ -i+" l"+r+","+ -r+" z";return u};e.widget("bio.fragment",{options:{name:null,desc:null,length:null,url:t,color:t,width:t,text:{goto_page:"Goto Page",def_desc:"No Description",def_name:"Unnamed Fragment"},helper:"clone"},_create:function(){var t=this.options,r=this,i=this.el=e(this.element[0]).addClass(n);t.name=i.attr("name")||t.name||t.text.def_name,t.desc=i.attr("desc")||t.desc||t.text.def_desc,t.length=i.attr("length")||t.length||0,t.url=i.attr("href")||t.url,t.color=t.color||next_color(),t.width=t.width||i.width(),i.width(t.width);var o=i.width(),u=i.height();this.paper=Raphael(this.element[0],o,u),this.frag=this.paper.path(""),this.name=this.paper.text(o/2,u/2,this.options.name).attr({fill:"white",font:"inherit"}),this.info=e("<div>").addClass(s).mousedown(function(e){e.stopPropagation()}),this.refreshInfo(),i.css({"border-color":t.color}),t.helper==="clone"&&(t.revert=!0,t.helper=function(){return e("<div>").addClass(n).css("z-index",200).append(i.children("svg").clone())}),this.el.tooltip({color:t.color,content:this.info,width:"125%"}),this._redraw_frag(),this._set_color()},_init:function(){},option:function(e,t){var n=this.options;if(t==null)return n[e];n[e]=t;switch(e){case"name":this._redraw_frag();break;case"desc":case"length":case"url":this.refreshInfo();break;case"width":this._redraw_frag();break;case"color":this.el.css({"border-color":this.options.color}),this._anim_color()}return this},refreshInfo:function(){var t=this.options;this.info.html(""),e('<div><p class="bio-length">'+t.length+"</p></div>").appendTo(this.info),e('<div><p class="bio-desc">'+t.desc+"</p></div>").appendTo(this.info),t.url!=null&&e("<div><a href="+t.url+' class="bio-url">'+t.text.goto_page+"</a></div>").appendTo(this.info)},disable:function(){this.info.tooltip("disable")},enable:function(){this.info.tooltip("enable")},ghost:function(e){e==null&&(e=!0),e?(this.name.attr("opacity",0),this.frag.attr({fill:null,stroke:"#555555","stroke-dasharray":"-"})):(this.name.attr("opacity",1),this._set_color(),this.frag.attr("stroke-dasharray",""))},_set_color:function(){var e=this.options.color.match(/\d+/g);this.frag.attr({fill:Raphael.hsl(e[0],e[1],e[2]),stroke:Raphael.hsl(e[0],e[1],Math.max(0,e[2]-10))})},_anim_color:function(){var e=this.options.color.match(/\d+/g),t=Raphael.animation({fill:Raphael.hsl(e[0],e[1],e[2]),stroke:Raphael.hsl(e[0],e[1],Math.max(0,e[2]-10))},1e3);this.frag.animate(t.delay(100))},_redraw_frag:function(){var e=this.el.width(),t=this.el.height();this.paper.setSize(e,t),this.frag.attr({path:u(e,t)}),this.name.attr({x:e/2,y:t/2,text:this.options.name});var n=this.options.name.length-1;while(this.name.getBBox().width+t>e)n-=1,this.name.attr({text:this.options.name.substr(0,n)+"..."})}})}(jQuery),function(e,t){var n="bio-fragment-select ui-widget",r="ui-icon-circle-triangle-e",i=function(e,t){return t.test(e.fragment("option","name"))||t.test(e.fragment("option","desc"))};e.widget("bio.fragmentSelect",e.bio.panel,{options:{title:t,help:t,text:{defaultTitle:"Fragment Selector",defaultHelp:"Drag and drop fragments to select them",filter:"filter",loading:"Loading fragments...",error:"Error",none_loaded:"No fragments are loaded",none_matching:"No fragments match the filter",showing_all:"Showing %total %fragment",showing_filter:"Showing %filter of %total %fragment",fragment:"fragment",fragments:"fragments",cberror:"An error occurred"},defaultHelper:"clone",height:400,src:t,color:null},_create:function(){this._super();var t=this,r=this.options,i=this.el=e(this.element[0]).addClass(n);this.stretch_factors={ul:1},this.timeout=null;var s=t._add_to_panel(e("<div>").addClass("searchbar"));this.search=e("<div>").search({text:{search:"filter"},change:function(){t.filter(t.search.search("value"))}}).appendTo(s),this.list=t._add_to_panel(e("<div>").addClass("list"));var o=this.ul=i.find("ul");o.length===1?o.detach().appendTo(this.list):o=this.ul=e("<ul>").appendTo(this.list),o.sortable({placeholder:"ui-widget-content",connectWith:".bio-panel ul",start:function(t,n){e(this).find(":bio-fragment").fragment("disable")},stop:function(t,n){e(this).find(":bio-fragment").fragment("enable")},receive:function(e,n){var i=n.item.find(":bio-fragment");i.fragment("option","color",r.color),t.setStatus('Added fragment "'+i.fragment("option","name")+'"',"ui-icon-circle-plus")},remove:function(e,n){var r=n.item.find(":bio-fragment");t.setStatus('Removed fragment "'+r.fragment("option","name")+'"',"ui-icon-circle-minus")}});var u=function(n){for(var i=0;i<n.length;i++){var s=n[i];e("<li>").append(e("<div>").attr({name:s.name,length:s.length,desc:s.desc,href:s.url})).appendTo(o)}o.find("li").each(function(){var t=e(this).width();e(this).children().fragment({color:r.color,width:t})}),t.setStatus(),o.animate({"margin-top":"0px"},"fast",function(){t.list.css("overflow-y","auto")})};if(r.src!=null)if(typeof r.src=="string")this.list.css("overflow","hidden"),o.css("margin-top",this.list.height()+"px"),this.setStatus(r.text.loading,"ui-icon-loading"),e.ajax({url:r.src,dataType:"json",success:u,error:function(e,n,r){t.setStatus(String(r),"ui-icon-alert")}});else{if(!e.isFunction(r.src))throw"options.src must be a string URL or a function";try{r.src(u,function(){t.setStatus(r.text.cberror,"ui-icon-alert")})}catch(a){t.setStatus(a.message,"ui-icon-alert")}}i.hasClass("ui-corner-all")&&this.search.addClass("ui-corner-all")},filter:function(t){var n=new RegExp(t,"i");this.el.find(":bio-fragment").each(function(){var t=e(this);i(t,n)?t.parent().show():t.parent().hide()}),this.setStatus()},showAll:function(){this.el.find(":bio-fragment").show()},setStatus:function(e,t){var n=this.list.find(":bio-fragment").length,i=this.list.find(":bio-fragment:visible").length;if(e==null){var s=this.options.text;n===0&&i===0?(e=s.none_loaded,t="ui-icon-alert"):n>0&&i===0?(e=s.none_matching,t="ui-icon-alert"):n===i?e=s.showing_all:e=s.showing_filter}this.status_icon.attr("class","ui-icon "+(t||r)),this.status_text.text(this._get_text(e,i,n))},_get_text:function(e,t,n){var r=this.options.text;return e.replace("%filter",t).replace("%total",n).replace("%fragment",n===1?r.fragment:r.fragments)}})}(jQuery),function(e,t){var n="bio-sequence-view ui-widget",r="bio-meta",i="bio-name",s="bio-desc",o="bio-overview",u="bio-view",a="bio-spacer",f="bio-zoomview",l="bio-slidearrow ui-widget-header",c="bio-slideleft",h="bio-slideright";e.widget("bio.sequenceView",e.bio.panel,{options:{title:t,help:t,text:{defaultTitle:"Fragment View",defaultHelp:"Drag to scroll around in the fragment",defaultStatus:"No fragment loaded"},height:400},_create:function(){this._super();var t=this,p=this.options,d=this.el=e(this.element[0]).addClass(n);this.stretch_factors={zoomview:5,spacer:1,overview:2};var v=this.metadata=e("<div>").addClass(r).appendTo(this.panel);this.name=e("<p>").addClass(i).text("Fragment Name").appendTo(v),this.desc=e("<p>").addClass(s).text("Fragment Description").appendTo(v),this.overview=e("<div>").addClass(o).appendTo(this.panel),this.viewpane=e("<div>").addClass(u).appendTo(this.overview),this.spacer=e("<div>").addClass(a).appendTo(this.panel);var m=this.zoomview=e("<div>").addClass(f).appendTo(this.panel);this.right_arrow=e("<div>").addClass(l+" "+h).append(e("<span>").addClass("ui-icon ui-icon-triangle-1-e")).appendTo(m),this.left_arrow=e("<div>").addClass(l+" "+c).append(e("<span>").addClass("ui-icon ui-icon-triangle-1-w")).appendTo(m),this.right_arrow.add(this.left_arrow).mouseenter(function(){e(this).addClass("ui-state-hover")}).mouseleave(function(){e(this).removeClass("ui-state-hover")})},_init:function(){this._super(),this.setStatus(this.options.text.defaultStatus)}})}(jQuery);